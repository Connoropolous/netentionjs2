<html>
    <head>
        <!-- openlayers -->
        <script src="http://www.openlayers.org/api/OpenLayers.js"></script>

        <!-- google maps -->
        <script src="http://maps.google.com/maps/api/js?v=3&amp;sensor=false"></script>

        <!-- mktree -->
        <script src="mktree/mktree.js"></script>
        <link type="text/css" rel="stylesheet" href="mktree/mktree.css"/>
        
        <!-- jQuery and jQuery-UI -->
        <link rel="stylesheet" href="http://code.jquery.com/ui/1.8.23/themes/base/jquery-ui.css" type="text/css" media="all" />
	<link rel="stylesheet" href="http://static.jquery.com/ui/css/demo-docs-theme/ui.theme.css" type="text/css" media="all" />
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js" type="text/javascript"></script>
        <script src="http://code.jquery.com/ui/1.8.23/jquery-ui.min.js" type="text/javascript"></script>                        
        <script src="http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>
        
        <!-- NowJS -->
        <script type="text/javascript" src="/nowjs/now.js"></script>
        
        <script src="map.js"></script>
	<link rel="stylesheet" href="map.css" type="text/css" media="all" />
                
        <title>Global Survival System - Map</title>
        
        <script>
            var heatMapDetailLevel = 4;
            var activeIndicators = [];


            function showGssPresentation() {
                $('#gssPresentation').html('<center><iframe src="https://docs.google.com/present/embed?id=d47pv44_347cb7r8thf&interval=60&loop=true&size=l" frameborder="0" width="700" height="559"></iframe></center>');
                $("#gssPresentation").dialog({
			height: 600,
                        width: 800,
                        zIndex: 5000,
			modal: true
		});
            }
            
            function addInterestButtons(indicator) {
                
            }
            
            function applyTemplate(template, params, target) {
                $( template ).tmpl( params).appendTo( target );                          
            }
            
            function initPresets() {
                var presets = [
                    { name: "1st World Civilization", desc: "The amenities and benefits of the world's most advanced societies." },                            
                    { name: "Camping", desc: "Camping in nature, away from civilization." },                            
                    { name: "3rd World Civilization", desc: "Developing regions must be ready to adapt to environmental problems." },                     
                    { name: "Food", desc: "Edible and drinkable substances" },
                    { name: "Disaster", desc: "When evacuation becomes a priority, avoid disaster with a set of minimal but critical concerns." },                            
                    { name: "Wellness", desc: "Healthcare, hospital, pharmacies, etc..." },                            
                    { name: "Fun", desc: "Entertainment and enjoyment." },           
                    { name: "Adventure", desc: "Adventure, quest, or surprising opportunity." },
                    { name: "Learning", desc: "Educational resources." }
                ];
                
                applyTemplate("#presetTemplate", presets, "#presets" );          
            }
            
            function updateSuggestions() {
                
                $('#tabsSuggestions').html('');
                var s = [
                    { name: "Adventure Medical Kits - Ultralight & Watertight", 
                      link: 'http://www.amazon.com/3M-Scotch-Strength-1-88-Inch-60-Yard',
                      imageURL: "http://ecx.images-amazon.com/images/I/41dcqml1aEL._AA115_.jpg",
                      reason: "Hurricane in proximity.  Prevent windows from shattering by using duct tape.",
                      price: "$8.77"
                    },                            
                    { name: "3M Scotch Pro Strength Duct Tape, 1.88-Inch by 60-Yard, 1-Pack", 
                      link: 'http://www.amazon.com/Adventure-Medical-Kits-Ultralight-Watertight/dp/B000WXX016',
                      imageURL: "http://ecx.images-amazon.com/images/I/41KMGevDemL._AA115_.jpg",
                      reason: "You are far from medical support.  In case of emergency, carry a first-aid kit.",
                      price: "$8.99"
                    }
                ];
                
                applyTemplate("#productSuggestionTemplate", s, "#tabsSuggestions" );          

            }
            
            function getHeatmapColor(lat, lon) {

                var d = geoDist( [lat, lon], [0,0])/1000.0;
                var r = 1.0 / ( 1.0 + d);
                var g = 0;
                var b = 0;
                
                r = Math.floor(r*256.0);
                g = Math.floor(g*256.0);
                
                return [ r, g, b ];
            }

            function drawHeatmap(divisions) {
                var map = document.getElementById("map");
                
                var mapHeat = document.getElementById("mapHeat");
                var w = theMap.size.w;
                var h = theMap.size.h;

                var ctx = mapHeat.getContext("2d");
                ctx.clearRect(0, 0, w, h);
                
                var extent = theMap.getExtent().transform(toProjection, fromProjection);
                var ul = new OpenLayers.LonLat(extent.left, extent.top);
                var br = new OpenLayers.LonLat(extent.right, extent.bottom);

                var bw = Math.abs(br['lon'] - ul['lon'])/divisions;
                var bh = Math.abs(ul['lat'] - br['lat'])/divisions;
                
                var pw = Math.ceil(w / divisions);
                var ph = Math.ceil(h / divisions);
                
                var py = ul['lat'], px;
                for (var y = 0; y < divisions; y++) {
                    px = ul['lon'];
                    for (var x = 0; x < divisions; x++) {
                        
                        var pl = new OpenLayers.LonLat(px, py);
                        var c = getHeatmapColor(py, px); //(py + bh/2.0, px + bw/2.0);

                        var pp = theMap.getViewPortPxFromLonLat( pl.transform( fromProjection, toProjection) );
                        //console.log(pp['x'], pp['y'], px, py);
                        
                        ctx.fillStyle="rgba(" + c[0] + ", " + c[1] + ", " + c[2] + ", 1.0)";
                        ctx.fillRect(pp['x'],pp['y'],pw,ph);
                        px += bw;
                    }
                    py -= bh;
                }
            }

            function updateHeatmap() {
                drawHeatmap(heatMapDetailLevel);                
            }
            
            
            function update() {
                updateHeatmap();
                updateSuggestions();
            }
            
            function updateHeatmapOpacity(o) { $('#mapHeat').css('opacity', o/100.0); }
            
            function updateHeatmapDetail(d) {
                heatMapDetailLevel = d;
                updateHeatmap();
            }
            
            now.name = prompt("What's your name?", "");  
            now.receive = function(name, message){
              $("#messages").append("<br>"+name+": "+message);
            }
            
            function send() {
              now.distribute($("#text-input").val());
            }
            
            $(function() {
		var tabs = $( "#tabs" ).tabs({
                    selected: 4
                });
                
                initPresets();
                
                initMap(function() {
                    update();
                });
                
                updateLocation();

                //test EQ data
                setTimeout(function() {
                    $.getScript("/indicator/geology/USGSEarthquake.client.js", function(data, textStatus, jqxhr) {
                            USGSEarthquakeClient.load();
                    });                                        
                }, 3000);
            });
        </script>
        
        <script id="presetTemplate" type="text/x-jquery-tmpl">
            <li><button>${name}</button>
                <p>${desc}</p>
            </li>
        </script>
        
        <script id="productSuggestionTemplate" type="text/x-jquery-tmpl">
            <a href="${link}">${name}</a><br/>
            <div style="float: left; width: 40%"><img src="${imageURL}"/></div>
            <div style="float: right; width: 55%"><p><b>${price}</b> ${reason}</p></div>
            <div style="clear:both"></div>
        </script>
        
    </head>


    <body>
        <div id="controls"> 
            
            <div id="tabs">
                    <ul>
                        <li><a href="#tabsTeam">Team</a></li>
                        <li><a href="#tabs-0">Goals</a></li>
                        <li><a href="#tabs-1">Interests</a></li>
                        <li><a href="#tabsSuggestions">Tools</a></li>
                        <li><a href="#tabsHelp">Help</a></li>
                    </ul>

                    <div id="tabsTeam">
                        <div id="messages"></div>
                        <br/>
                        <input type='text' id="text-input"/>
                        <input type='submit' id="send-button" onclick="send()" value="send"/>
                    </div>
                
                    <div id="tabs-0">
                        <ul id="presets">                            
                        </ul>    
                    </div>
                    
                    <div id="tabs-1">
                        <!-- Interests -->
                        <ul class="mktree" id="tree1">

                            <li>Shelter
                                <ul>
                                    <li>Bridges</li>
                                    <li>Homeless Shelters</li>
                                    <li>Hotels</li>
                                    <li>Campgrounds</li>
                                    <li>CouchSurfing</li>
                                    <li>Hostels</li>
                                    <li>Apartments and Sublets</li>
                                    <li>Real Estate</li>
                                    <li>Occupy</li>
                                </ul>
                            </li>
                            <li>Food
                                <ul>
                                    <li>Groceries<br/>
                                        <input type="range"  min="0" max="100" />
                                    </li>
                                    <li>Edible Vegetation</li>
                                    <li>Public Kitchens and Potlucks</li>
                                    <li>Community Gardens</li>
                                </ul>
                            </li>
                            <li>Supplies and Tools</li>
                            <li>Healthcare</li>
                            <li>Weather, Climate, & Geology
                                <ul>
                                    <li>USGS Earthquakes</li>
                                </ul>
                            </li>
                            <li>Pollution
                                <ul>
                                    <li>Nuclear Facilities<br/>
                                        <input type="range"  min="0" max="100" />
                                    </li>
                                    <li>Superfund Sites</li>
                                </ul>
                            </li>
                            <li>Society & Community</li>
                            <li>Transportation</li>
                            <li>Communication</li>
                            <li>Money</li>
                            <li>Entertainment</li>
                            <li>Freedom</li>

                        </ul>

                        <p>
                            <a href="#" class="button" onClick="expandTree('tree1');return false;">Expand All Nodes</a><br/>

                            <A class="button" href="#" onClick="collapseTree('tree1'); return false;">Collapse All Nodes</A><br/>

                            <!-- <A class="button" href="#" onClick="expandToItem('tree1','login'); return false;">Expand to a certain location</A> -->
                        </p>
                        
                        <p>
                            Heatmap Transparency: <input type="range"  min="0" max="100" onchange="updateHeatmapOpacity(this.value)"/>
                        </p>
                        <p>
                            Heatmap Detail: <input type="range"  min="2" max="32" step="1" onchange="updateHeatmapDetail(this.value)"/>
                        </p>

                    </div>
                   
                    <div id="tabsSuggestions">
                    </div>
                
                    <div id="tabsHelp">
                        <h1>What is GSS?</h1>
                        <p><button onclick="showGssPresentation()">Watch Presentation</button></p>
                        <p>Analyze all physical locations, and the transitions between them, to find those which seem appropriate for a biological organism - measured according to certain heuristics.</p>
                        
                        <p>Appropriateness of a given environment, at a specific time, for a specific organism (human, animal, or plant, etc...), may be calculated in terms of its needs.</p>
                        
                        <p>The tool must be easy and free for all people (and possibly animals) to use, modify or improve it.</p>
                                               
                        <p>This tool is equivalent to a universal constitution that can logically grant all beings equal rights to existence - a distributed government that attempts to guarantee ecstatic survival.</p>

                        <p>Analyzes all aspects of a group of organisms' existence within an ecosystem of demands and available resources...</p>
                        <ul>
                            <li>including all biological and psychological needs which could possibly affect the length and quality of life of a living being...</li>
                            <li>including humans, animals, plants</li>
                            <li>or abstract entities such as ecosystems, families, organizations, and corporations.</li>
                        </ul>
                    </div>
                
            </div>
            
        </div>        
        
        <div id="map"></div>
        <canvas id="mapHeat"></canvas>
        
        <div id="gssPresentation" title="What is GSS?" style="display: none; z-index: 5000">
            
        </div>

    </body>
</html>
