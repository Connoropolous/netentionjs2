
<!DOCTYPE html>
<html>
    <head>
        <title>Netention</title>
        
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
        <script src="netention.js"></script> 
        
        <script>
        
            function getEditedFocus() {
                var x = { };
                var f = window.self.get('focus');
                
                x.uri = f.uri;
                x.type = f.type;
                x.typeStrength = f.typeStrength;
                
                if (!x.author)
                    x.author = window.self.get('clientID');
                x.when = Date.now();
                
                x.name = $('#FocusName').val();
                
                var fdv = $('#FocusDescription').val();
                if (fdv.length > 0)
                    x.text = fdv;
                
                x.values = [];
                
                var pe = window.propertyEdits;
                for (var p = 0; p < pe.length; p++) {
                    var px = pe[p];
                    x.values.push( { uri: px.data('property'), value: px.data('value')() } );
                }
                
                if (focusMap) {
                    var r = focusMap.location();    
                    x.geolocation = [ r.lat, r.lon ];
                }
                
                return x;
            }
            
            var focusMap;
            
            function setFocus(x) {
                if (!x) {
                    x = { };
                }
                
                if (!x.uri)
                    x.uri = uuid();
                
                if (!x.values)
                    x.values  = [];
                
                if (!x.type) {
                    x.type = [];
                    x.typeStrength = [];
                }
                                
                                
                $('#FocusTypes').html('');
                $('#FocusName').val(x.name);
                $('#MatchedTypes').html('');

                
                if (x.text) {
                    $('#FocusDescriptionSection').show();
                    
                    initDescriptionRichText();
                    $('#FocusDescription').val(x.text);
                }
                else {
                    $('#FocusDescriptionSection').hide();
                }
                
                
                if (x.geolocation) {
                    $('#FocusMapSection').show();                    
                    $('#focusMap').html('');
                    focusMap = initLocationChooserMap('focusMap', x.geolocation);
                }
                else {
                    $('#FocusMapSection').hide();
                    $('#focusMap').html('');
                    focusMap = null;
                }
                
                
                if (x.type.length == 0) {
                    $('#FocusTypes').hide();
                }
                else {
                    $('#FocusTypes').show();
                    for (var k = 0; k < x.type.length; k++) {
                        var t = x.type[k];
                        var typeWidget = $('<span class="dropdown">');
                        
                        var b = $('<a class="btn dropdown-toggle" data-toggle="dropdown" href="#">' + t + '</a>');
                        typeWidget.append(b);
                        
                        var u = $('<ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">');
                        typeWidget.append(u);
    
    
                        var tv = window.self.get('types')[t];
                        if (!tv)
                            tv = { };
                        
                        var pr = getProperties(tv);                        
                        var propertiesAdded = 0;
                        for (var p in pr) {
                            (function() {
                                var pri = p;
                                var a = $('<a href="#">' + pr[p].name + '</a>');
                                a.click(function() { 
                                    var f = getEditedFocus();
                                    if (acceptsAnotherProperty(f, pri)) {
                                        commitFocus(addProperty(f, pri));
                                    }
                                    
                                });
                                var l = $('<li/>'); l.append(a);
                                u.append(l);                        
                            })();
                            propertiesAdded++;   
                        }
                        
                        if (propertiesAdded)
                            u.append('<br/>');
                            
                        {
                            var si = $('<ul></ul>');
                            si.append('<button title="25%" style="background-color: rgba(100, 100, 100, 0.5)">&nbsp;</button>');
                            si.append('<button title="50%"style="background-color: rgba(150, 150, 150, 0.5)">&nbsp;</button>');
                            si.append('<button title="75%"style="background-color: rgba(200, 200, 200, 0.5)">&nbsp;</button>');
                            si.append('<button title="100%"style="background-color: rgba(250, 250, 250, 0.5)">&nbsp;</button>');
                            u.append(si);
                        }
                        
                        (function() {
                            var kk = k;
                            var rb = $('<a href="#">Remove</a>');
                            rb.click(function() {
                                var f = window.self.get('focus');
                                commitFocus(removeType(f, kk));
                            });
                            var rbi = $('<li/>'); rbi.append(rb);
                            u.append(rbi);
                        }());
                        (function() {
                            var kk = k;
                            var rb = $('<a href="/#/type/' + k + '">Edit Type</a>');
                            var rbi = $('<li/>'); rbi.append(rb);
                            u.append(rbi);
                        }());
                        
                        
                        $('#FocusTypes').append(typeWidget);
                    }
                    
                }
                
                $('#FocusProperties').html('');
                
                window.propertyEdits = [];
                if (x.values) {
                    for (var k = 0; k < x.values.length; k++) {
                        var pr = x.values[k];
                        var pv = window.self.get('properties')[pr.uri];
                        var pe = newPropertyEdit(pr, pv);
                        window.propertyEdits.push(pe);
                        $('#FocusProperties').append(pe);
                    }
                }
                
            }

            function commitFocus(f) {
                window.self.set('focus', f );
                window.self.trigger('change:focus');                
            }

            function updateTypes() {
                //THIS CURRENTLY ASSUMES THAT ALL TYPE ID's ARE IN THE FOLLOWING FORMAT:
                //  package.type
                //ex:
                //  general.Human
                
                var types = window.self.get('types');
                var typeMenu = { };
                for (var k in types) {
                    var x = k.split('.');                        
                    
                    if (!typeMenu[x[0]])
                        typeMenu[x[0]] = [ ];
                
                    typeMenu[x[0]].push(k);                    
                }
                
                var t = $('#TypeMenu');                
                t.html('');
                
                
                for (var k in typeMenu) {
                    var d = $('<li class="dropdown-submenu"></li>');
                    t.append(d);
                     
                    var b = $('<a tabindex="-1" href="#">' + k + '</a>');
                    d.append(b);
                    
                    var u = $('<ul class="dropdown-menu"></ul>');
                    d.append(u);
                    
                    for (var c = 0; c < typeMenu[k].length; c++) {
                        (function() {
                            var id = typeMenu[k][c];
                            var label = id.split('.')[1];
                            var a = $('<a href="#">' +  label + '</a>');
                            a.click(function() {
                                var f = getEditedFocus();
                                if (!hasType(f, id)) {
                                    commitFocus(addType(f, id));
                                }
                            });
                            
                            var l = $('<li/>'); l.append(a);
                            
                            u.append(l);
                        })();
                        
                    }
                                  
                    t.dropdown();
                }

            }
                                
            function updateFocus() {
                setFocus(window.self.get('focus'));                
            }
            
            function initDescriptionRichText() {
                $('#FocusDescriptionSection').html('<textarea id="FocusDescription"></textarea>');
                $('#FocusDescription').wysihtml5();                                           
            }
            
            function initUI(self) {
                $('body').timeago();
                
                self.on('change:attention', function() {
                    updateView();
                }); 
                
                self.on('change:focus', function() {
                    updateFocus();
                    updateView();
                }); 
            
                self.on('change:currentView', function() {
                    updateView();
                });
                
                self.on('change:types', function() {
                    updateTypes();
                    updateFocus();
                });

                $('#ViewMap').click(function() { self.set('currentView', 'map');  });
                $('#ViewList').click(function() { self.set('currentView', 'list');  });
                $('#ViewSlides').click(function() { self.set('currentView', 'slides');  });
                $('#ViewGraph').click(function() { self.set('currentView', 'graph');  });
                $('#ViewTime').click(function() { self.set('currentView', 'time');  });
                $('#ViewTrends').click(function() { self.set('currentView', 'trends');  });
                
                $('#ToggleDescriptionButton').click(function() {
                    $('#FocusDescriptionSection').toggle();
                    if ($('#FocusDescriptionSection').is(':visible')) {
                        $('#FocusDescription').val(' '); //initialize as non-empty

                        //reset rich text editor
                        initDescriptionRichText();
                    }
                });
                $('#ToggleLocationButton').click(function() {
                    var x = self.get('focus');
                    if (x.geolocation) {
                        if (confirm('Remove geolocation?')) {
                            var f = getEditedFocus();
                            delete f.geolocation;
                            commitFocus(f);
                        }
                    }  
                    else {
                        var f = getEditedFocus();
                        f.geolocation = [];
                        commitFocus(f);
                    }
                });
                $('#SaveButton').click(function() {
                    var p = getEditedFocus();
                    self.notice(p);
                    self.pub(p);
                    $.pnotify({
                        title: 'Saved',
                        text: p.uri                        
                    });         
                });

                {
        			var msgs = [ 'I think', 'I feel', 'I wonder', 'I know', 'I want' ];
    				            
    				function updatePrompt() {
    					var l = msgs[parseInt(Math.random() * msgs.length)];
    					$('#FocusName').attr('placeholder', l + '...');					
    				} 
                    				
    				setInterval(updatePrompt, 7000);
    				updatePrompt();
                }

                function isValidKeyword(x) {
                    if (x.length < 2) return false;
                    if (x == 'and') return false;
                    if (x == 'or') return false;
                    return true;
                }
                
                function getKeywords(s) {
                    return s.toLowerCase().replace(',',' ').replace('\.',' ').
                            replace('\/',' ').split(' ');
                }
                
                function updateTypeSuggestions(t) {
                    t = getKeywords(t);
                    
                    var keywords = _.filter(t, isValidKeyword);
                    
                    var mt = $('#MatchedTypes');
                    mt.html('');
                    
                    var matched = { };
                    _.each(keywords, function(keyword) {
                        var types = window.self.types();
                        
                        function keywordMatchesType(k, t) {
                            var name = types[t].name;
                            var desc = types[t].description;
                            if (desc) {
                                name = name + ' ' + desc;
                            }
                            var kk = getKeywords(name);
                            
                            return _.contains(kk, k);                            
                        }
                        
                        for (var t in types) {
                            if (keywordMatchesType(keyword, t)) {
                                matched[t] = true;
                            }
                        }
                        
                    });
                    
                    for (var m in matched) {
                        (function() {
                            var e = getEditedFocus();
                            if (hasType(e, m))
                                return;
                                
                            var mx = window.self.getType(m);
                            var mn = mx.name;
                            
                            var bb = $('<button>' + mn + '?</button>');
                            bb.click(function() {
                                commitFocus(addType(e, mx.uri, 1.0));
                            });
                            mt.append(bb);                        
                        })();
                    }
                }
                
                var throttledUTS = _.throttle(updateTypeSuggestions, 700);
                
                $('#FocusName').keyup(function() {
                    var t = $('#FocusName').val();
                    throttledUTS(t);
                });
                
                updateTypes();
                updateFocus();
                
            }
            
            function getRelevant() {
                return _.values(window.self.get('attention'));
            }
            
            function updateView() {
                var s = window.self;

                var view = s.get('currentView');

                var o = $('#ViewOptions');
                var v = $('#View');
                
                v.html('');
                o.html('');
                
                if (view === 'list') {
                    $('#myTab a:first').tab('show');     
                    
                    var sort = s.get('list-sort') || 'Recent';
                    var scope = s.get('list-scope') || 'Public';
                    
                    var now = Date.now();
                    var location = s.myself().geolocation;
                    
                    var relevance = { };
                    for (var k in s.get('attention')) {
                        
                        var x = s.getObject(k);
                        
                        //scope prefilter
                        if (scope == 'Mine') {
                            if (x.author != s.id())
                                continue;
                        }
                        else if (scope == 'Others') {
                            if (x.author == s.id())
                                continue;                            
                        }
                        
                        //sort
                        var r = 1.0;                        
                        if (sort == 'Recent') {
                            if (!x.when)
                                continue;
                            var ageSeconds = (now - x.when) / 1000.0;
                            r = Math.exp(-ageSeconds/1000.0);
                        }
                        else if (sort == 'Near') {
                            
                            if (!location) {
                                continue;
                            }
                            if (!x.geolocation) {
                                continue;
                            }
                            
                            var distance = geoDist(location, x.geolocation);
                            r = Math.exp(-distance/10000.0);
                        }
                        else if (sort == 'Relevant') { 
                            var m = getTypeMatch(s.focus(), x);
                            r *= m;
                        }
                        
                        
                        relevance[k] = r;
                    }
                    
                    var relevant = _.keys(relevance);
            		relevant.sort(function(a, b) {
                	    return relevance[b] - relevance[a];
            		});
                    
                    for (var x = 0; x < relevant.length; x++) {
                        var xx = s.get('attention')[relevant[x]];                        
                        var rr =  relevance[relevant[x]];
                        v.append(newObjectView( s, xx , function() { }, rr ));                     
                    }
                    
                    
                    var sortSelect = $('<select><option>Relevant</option><option>Recent</option><option>Near</option></select>'); //<option>By Author</option>
                	dataViewSort = 'By Relevance';
                	sortSelect.change(function() {
                		var v = $(this).val();
                        s.set('list-sort', v);
                		updateView();
                	});
                    sortSelect.val(sort);
                	o.append(sortSelect);
                	
                    /*
                	var proxFilter = $('<select><option>Anywhere</option><option>Near 1km</option><option>Near 5km</option></select>');
                	proxFilter.change(function() {
                		requestUserSupport('Proximity Filter');
                	});
                	o.append(proxFilter);
                
                	var timeFilter = $('<select><option>Anytime</option><option>Recent 1m</option><option>Recent 5m</option><option>Recent 30m</option><option>Recent 1h</option><option>Recent 24h</option></select>');
                	timeFilter.change(function() {
                		requestUserSupport('Time Filter');
                	});
                	o.append(timeFilter);
                	*/
                    
                	var authorFilter = $('<select><option>Public</option><option>Mine</option><option>Others</option></select>');
                	authorFilter.change(function() {
                    	var v = $(this).val();
                        s.set('list-scope', v);
                		updateView();
                	});
                    authorFilter.val(scope);
                	o.append(authorFilter);
                    
                    $('body').timeago('refresh');


                }
                else if (view === 'map') {
                    
                    var e = uuid();
                    $('<div style="width: 100%; height: 100%"/>').attr('id', e).appendTo(v);
                    initLocationChooserMap(e);
                    
                }
                else if (view === 'trends') {
                    
                    //total objects
                    v.append('Known objects: ' + _.size(s.get('attention')));
                    
                    v.append('<br/><br/>');
                    
                    //tag distribution (bar chart)
                    v.append('Tag Distribution: (random numbers for now)<br/>');
                    
                    var xu = uuid();
                    var xx = $('<div></div>').attr('id', xu);
                    v.append(xx);
                    
                    var labels = [];
        			var values = [];
    				for (k in [1,2,3]) {
    					var s = Math.random();
    					labels.push(k + '(' + parseInt(s) + ')');
    					values.push(s);
    				}
    				
    				var plot2 = $.jqplot(xu, 						
                       [values], {
                       seriesDefaults: {renderer: $.jqplot.BarRenderer},
                       series:[
                        {pointLabels:{
                           show: true,
                           labels:labels
                         }}],
                       axes: {
                         xaxis:{renderer:$.jqplot.CategoryAxisRenderer},
                         yaxis:{padMax:1.3}}
                    });                    
                    
                }
                else {
                    v.html('Unknown view: ' + view);                    
                }
                
            }
            
            function showEditedFocus() {
                $.pnotify({
                    title: 'Current Focus (JSON)',
                    text: (JSON.stringify(getEditedFocus(), null, 4))
                });                
            }
            
            function cloneFocus() {
                var y = getEditedFocus();
                var oldURI = y.uri;
                y.uri = uuid();
                commitFocus(y);
                $.pnotify({
                    title: 'Cloning...',
                    text: oldURI + ' -> ' + y.uri
                });                
                return y;
            }
            
            function deleteFocus() {
                var f = window.self.get('focus');
                
                $.pnotify({
                    title: 'Delete coming soon',
                    text: f.uri
                });                
                    
            }
            
                        
            
            $(document).ready(function(){
            
			    netention(function(self) {
                    
                    window.self = self;        
                    self.set('focus', { });
                    self.set('currentView', 'list');
                    
                    self.getObjects('', function(obj) { }, function() { 
                        
                        self.listenAll(true);
                        
                        //SETUP ROUTER
                        var Workspace = Backbone.Router.extend({
    
                          routes: {
                            "new":                  "new",
                            "me":                   "me",    // #help
                            "help":                 "help",    // #help
                            "query/:query":         "query",  // #search/kiwis
                            "object/:id":           "object"
                            //"search/:query/:page":  "query"   // #search/kiwis/p7
                          },
                          
                          new: function() {
                                commitFocus({ 
                                    uri: uuid()
                                });
                                //set relevancy filter to 'mine
                          },
                        
                          me: function() {
                                commitFocus( self.myself() );
                                //set relevancy filter to 'mine
                                self.set('currentView', 'list');
                          },
                            
                          help: function() {
                                commitFocus({
                                   uri: uuid(),
                                   type: [ 'help '], typeStrength: [ 1.0 ]
                                });
                          },
                        
                          query: function(query) {
                                commitFocus({
                                   uri: uuid(),
                                   name: query
                                });
                          },
                          
                          object: function(id) {
                              var a = self.get('attention');
                              commitFocus(a[id]);
                          }
                        
                        });
                        
    
                        var w = new Workspace();
                        Backbone.history.start();
                        
                        initUI(self);
                        
                    });
                                        
                    
			    });
                
            });
   
        </script>
        
        <style>
    		#SelfTarget, #DataTarget {
    			position: fixed;			
    			height: 100%;
    		}
    		
    		#DataTarget {
    			width: 64%;
    			right:0.5em;			
                z-index: -5000;
    		}
    		
    		#SelfTarget {
    			width: 32%;
    			left: 0.5em;			
                padding-left: 0.5em;
    		}
    		
    		#Menu {
    			display: none;
    		}
            
            #ViewSelect, #ViewOptions {
                width: 48%;
            }
            #ViewSelect {
                float: left;
            }
            #ViewOptions {
                text-align: right;
                float: right;
                padding-top: 0.5em;
            }
            #focus {
                width: 100%;
            }
            #focus div {
                padding-top: 0.5em;
                padding-bottom: 0.25em;                
                width: 100%;
                
            }
            .FocusSection {
                margin-bottom: 0.3em;
                
                padding: 0.2em;
                border-right: 5px solid rgba(125,25,0,0.5);
                padding-bottom: 1.0em;	
            
            /*
               -webkit-transition:border-color 2.618s ease-in;  
               -moz-transition:border-color 2.618s ease-in;  
               -o-transition:border-color 2.618s ease-in;*/  
            
            	-webkit-transition:background-color 0.618s ease-in;  
               -moz-transition:background-color 0.618s ease-in;  
               -o-transition:background-color 0.618s ease-in;  

            }
            
            #focusName, #focusDescription {
                width: 100%;
            }
            #SaveButtonWrapper {
                //text-align: right;
                float: right;
            }
            #View {
                clear: both;
                width: 100%;
                height: 100%;
                overflow: auto;
            }
            
            .map {
                width: 100%;
                height: 200px;
            }
            
            #FocusName, #FocusDescription {
                width: 100%;
            }
            #FocusDescriptionSection, #FocusMapSection {
                padding-left: 1.25em;
            }
            
            #MenuWrapper {
                margin-bottom: 1.5em;
            }
            #ViewOptions select {
                width: auto;
            }
            .PropertyRemoveButton {
                float: right;
            }
            
            
	    </style>    
        
        
    </head>
    
    <body>
        
        <div id="SelfTarget">
            <div id="MenuWrapper">
                <span id="MainMenu" class="dropdown">
                  <a class="btn dropdown-toggle" data-toggle="dropdown" href="#" title="Main"><i class="icon-user"></i></a>
                  <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                    <li><a href="/#/new">New</a></li>
                    <br/>
                    <li><a href="/#/me">Me</a></li>
                    <li><a href="/#/team">Team</a></li>
                    <li><a href="/#/trends">Trends</a></li>
                    <li><a href="/#/types">Types</a></li>
                    <li><a href="/plugins.html" target="_blank">Plugins</a></li>
                    <li class="dropdown-submenu">
                        <a tabindex="-1" href="#">Options</a>
                        <ul class="dropdown-menu">
                            <li><a href="#">Listen to all Channels</a></li>
                            <li><a href="#">Silence</a></li>
                        </ul>
                    </li>
                    <br/>
                    <li><a href="/login.html">Login</a></li>
                    <li><a href="/logout">Logout</a></li>
                    <br/>
                    <li><a href="/#/help">Help</a></li>
                    
                  </ul>
                  <!-- <a class="btn" href="#">Location</a> -->
                </span>            
                
                <span id="TypeMenu2"></span>
            </div>
                
            
            <div id="focus">

                <div>
                    <input id="FocusName" type="text" x-webkit-speech="x-webkit-speech"/>
                </div>
                <div id="MatchedTypes"></div>
                
                <div id="FocusTypes"></div>
                
                <div id="FocusDescriptionSection">
                    <textarea id="FocusDescription"></textarea>
                </div>
                <div id="FocusMapSection">
                    <div id="focusMap" class="map" style="height: 200px; width: 100%">
                    </div>
                </div>
                
                <div id="FocusProperties">
                    
                </div>
                    
                <div id="SaveButtonWrapper" style="width: auto">
                    <span class="dropdown">
                        <a class="btn dropdown-toggle" data-toggle="dropdown" href="#" title="Tag"><i class="icon-tag"></i></a>
                        <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel" id="TypeMenu">
                        </ul> 
                    </span>
                    
                    <span class="btn-group">


                        <button id="ToggleDescriptionButton"><i class="icon-pencil"></i></button>                
                        <button id="ToggleLocationButton"><i class="icon-globe"></i></button>
                        <button id="AttachFileButton"><i class="icon-file"></i></button>                
                        <button id='SaveButton' class="btn" title="Save"><i class="icon-check" title="Save"></i></button>
                        <button class="btn dropdown-toggle" data-toggle="dropdown">
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a href="javascript:showEditedFocus();">Export...</a></li>
                            <li><a href="javascript:cloneFocus();">Clone...</a></li>
                            <li><a href="javascript:deleteFocus();">Delete</a></li>
                        </ul>
                    </span>
                </div>
                
            </div>
        </div>
        
	    <div id="DataTarget">
            <div>
                <span id="ViewSelect">
                    <ul class="nav nav-tabs">
                      <li><a href="#" id='ViewList' data-toggle="tab" title="List"><i class="icon-th-list"></i></a></li>
                      <li><a href="#" id='ViewMap' data-toggle="tab" title="Map"</a><i class="icon-globe"></i></a></li>
                      <li><a href="#" id='ViewTime' data-toggle="tab" title="Time"><i class="icon-time"></i></a></li>
                      <li><a href="#" id='ViewSlides' data-toggle="tab" title="Slides"><i class="icon-play"></i></a></li>
                      <li><a href="#" id='ViewGraph' data-toggle="tab" title="Graph"><i class="icon-random"></i></a></li>
                      <li><a href="#" id='ViewTrends' data-toggle="tab" title="Trends"><i class="icon-signal"></i></a></li>
                    </ul>
                </span>
                <span id="ViewOptions">
                    
                </span>
            </div>
            <div id="View">
                
            </div>
         
	    </div>


    </body>
</html>
